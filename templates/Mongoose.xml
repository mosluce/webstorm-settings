<templateSet group="Mongoose">
  <template name="mgmodel" value="$DESCRIPTION$&#10;&#10;var mongoose = require('mongoose');&#10;var Schema = mongoose.Schema;&#10;&#10;module.exports = {&#10;    name: '$NAME$',&#10;    schema: new Schema({&#10;        $END$&#10;    }, {/*options*/})&#10;};" description="model" toReformat="true" toShortenFQNames="true">
    <variable name="DESCRIPTION" expression="" defaultValue="" alwaysStopAt="true" />
    <variable name="NAME" expression="" defaultValue="" alwaysStopAt="true" />
    <context>
      <option name="JAVA_SCRIPT" value="true" />
    </context>
  </template>
  <template name="mgsetup" value="//npm install --save mongoose&#10;//npm install --save mongoose-timestamp&#10;//npm install --save bluebird&#10;&#10;var mongoose = require('mongoose');&#10;var timestamps = require('mongoose-timestamp');&#10;var Schema = mongoose.Schema;&#10;var Promise = require('bluebird');&#10;&#10;/**&#10; * 設定資料庫連線&#10; */&#10;function setup() {&#10;    return new Promise(function (resolve, reject) {&#10;        var conn = mongoose.createConnection();&#10;&#10;        // CONNECTION EVENTS&#10;        // When successfully connected&#10;        conn.on('connected', function () {&#10;            console.log('Mongoose default connection open to ' + process.env.MONGO_URL);&#10;&#10;            global.mongooseConnection = conn;&#10;&#10;            registerModels();&#10;&#10;            resolve();&#10;        });&#10;&#10;        // If the connection throws an error&#10;        conn.on('error', function (err) {&#10;            console.log('Mongoose default connection error: ' + err);&#10;            reject(err);&#10;        });&#10;&#10;        // When the connection is disconnected&#10;        conn.on('disconnected', function () {&#10;            console.log('Mongoose default connection disconnected');&#10;        });&#10;&#10;        // If the Node process ends, close the Mongoose connection&#10;        process.on('SIGINT', function () {&#10;            conn.close(function () {&#10;                console.log('Mongoose default connection disconnected through app termination');&#10;                process.exit(0);&#10;            });&#10;        });&#10;&#10;        conn.open(process.env.MONGO_URL);&#10;    });&#10;}&#10;&#10;function registerModels() {&#10;    //TODO: register models&#10;    var models = global.models || {};&#10;    var conn = global.mongooseConnection;&#10;&#10;    var fs = require('fs');&#10;    var path = require('path');&#10;&#10;    var dir = path.join(__dirname, '..', '..', 'app', 'models');&#10;&#10;    var files = fs.readdirSync(dir);&#10;&#10;    for (var i in files) {&#10;        var file = files[i];&#10;        var pattern = /\.js$/;&#10;&#10;        if (!pattern.test(file)) continue;&#10;&#10;        var config = require(path.join(dir, file))(Schema);&#10;&#10;        if (models[config.table]) continue;&#10;&#10;        var schema = new Schema(config.schema, config.options);&#10;        schema.plugin(timestamps);&#10;&#10;        conn.model(config.table, schema);&#10;    }&#10;&#10;    global.models = conn.models;&#10;}&#10;&#10;exports.setup = setup;" toReformat="false" toShortenFQNames="true">
    <context>
      <option name="JAVA_SCRIPT" value="true" />
    </context>
  </template>
</templateSet>